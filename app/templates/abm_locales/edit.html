{% extends "core/base.html" %}
{% block content %}
<style>
  .form-wrap{
    /* full width */
    width:100%;
    max-width:none;             /* antes: 900px */
    margin:0;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)), var(--bg-750, #141a21);
    border:1px solid var(--divider, rgba(255,255,255,.08));
    border-radius:14px; padding:1.5rem;
    display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1rem;
  }
  h1{ color:#eaf3ee; margin-bottom:1rem; font-size:1.4rem; }
  label{ display:flex; flex-direction:column; font-weight:600; color:var(--text-300, #c9d2d0); font-size:.9rem; }
  input{
    margin-top:.35rem; padding:.55rem .7rem; border-radius:8px;
    border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
    color:#fff; font-size:.95rem;
  }
  input:focus{ outline:none; border-color:var(--brand, #16a34a); background:rgba(255,255,255,.1); }
  .hint{ font-size:.75rem; color:var(--text-500, #8aa09a); margin-top:.2rem; }

  .form-actions{
    grid-column:1 / -1; display:flex; gap:.8rem; justify-content:flex-start; flex-wrap:wrap; margin-top:.5rem;
  }
  .btn-save{
    background:var(--brand, #16a34a); color:#fff; border:none; padding:.7rem 1.2rem;
    border-radius:10px; font-weight:700; cursor:pointer; transition:filter .15s, transform .1s;
  }
  .btn-save:hover{ filter:brightness(1.05); transform:translateY(-1px); }
  .btn-cancel{
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:#e7e7e7;
    padding:.7rem 1.2rem; border-radius:10px; text-decoration:none; font-weight:600;
  }
  .btn-cancel:hover{ background:rgba(255,255,255,.12); }

  /* --- mapa --- */
  .map-card{
    grid-column:1/-1;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)), var(--bg-750);
    border:1px solid var(--divider); border-radius:14px; overflow:hidden;
  }
  .map-card header{
    display:flex; align-items:center; gap:8px; justify-content:space-between;
    padding:10px 12px; border-bottom:1px solid var(--divider); color:#eaf3ee;
  }
  #map-local{ width:100%; height:420px; }
  .map-tools{ display:flex; gap:8px; align-items:center; }
  .pill{
    padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.08); color:#fff; font-weight:600; cursor:pointer;
  }
</style>

<h1>{{ 'Nuevo Local' if not item else 'Editar Local ' ~ item.id }}</h1>

<form method="post" class="form-wrap" id="formLocal">
  {% if not item %}
    <input type="hidden" name="id" id="id">
  {% endif %}

  <label>Nombre
    <input name="name" id="name" required value="{{ item.name if item }}">
  </label>

  <label>Ciudad
    <input name="city" value="{{ item.city if item }}">
  </label>

  <label>Latitud
    <input name="lat" id="lat" required pattern="-?\d{1,2}\.\d+" value="{{ item.lat if item }}">
    <div class="hint">Ejemplo: -25.298765</div>
  </label>

  <label>Longitud
    <input name="lon" id="lon" required pattern="-?\d{1,3}\.\d+" value="{{ item.lon if item }}">
    <div class="hint">Ejemplo: -57.642345</div>
  </label>

  {# ‚õî Se ocultan Rank y Venta/d√≠a #}
  {# (si alg√∫n d√≠a quer√©s reactivarlos, peg√°s aqu√≠ los 2 labels que ten√≠as) #}

  {% if item %}
  <label style="align-items:center; flex-direction:row; gap:.6rem; margin-top:.4rem">
    <input type="checkbox" name="active" {% if item.active %}checked{% endif %} style="width:1.1rem; height:1.1rem"> Activo
  </label>
  {% endif %}

  <!-- Mapa: queda igual que lo ten√©s ahora -->
  <div class="map-card">
    <header>
      <strong>Mapa (click para completar Lat/Lon)</strong>
      <div class="map-tools">
        <button type="button" class="pill" id="btnGeoloc">Usar mi ubicaci√≥n</button>
        <span class="hint">Centro actual: {{ depot.name if depot else '‚Äî' }}</span>
      </div>
    </header>
    <div id="map-local"></div>
  </div>

  <div class="form-actions">
    <button type="submit" class="btn-save">üíæ Guardar</button>
    <a href="{{ url_for('abm_locales.list_locales') }}" class="btn-cancel">Cancelar</a>
  </div>
</form>

<!-- Leaflet (CSS/JS) y MarkerCluster (opcional) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // ===== Helpers =====
  const form = document.getElementById('formLocal');
  const nameInput = document.getElementById('name');
  const idInput = document.getElementById('id');
  const latInput = document.getElementById('lat');
  const lonInput = document.getElementById('lon');

  {% if not item %}
  // Autogenerar ID al escribir nombre
  nameInput.addEventListener('input', ()=>{
    const raw = nameInput.value.trim().toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-z0-9\s_-]/g,"").replace(/\s+/g,"_");
    idInput.value = raw ? `agromax_${raw}` : "";
  });
  {% endif %}

  // Validaci√≥n b√°sica
  form.addEventListener('submit', (ev)=>{
    const la = parseFloat(latInput.value), lo = parseFloat(lonInput.value);
    if(isNaN(la) || la<-90 || la>90){ alert('Latitud inv√°lida'); ev.preventDefault(); return; }
    if(isNaN(lo) || lo<-180 || lo>180){ alert('Longitud inv√°lida'); ev.preventDefault(); return; }
  });

  // ======= MAPA =======
  const DEPOT = {{ (depot or {}) | tojson }};         // {name, lat, lon} o {}
  const LAYERS_URL = {{ (layer_urls | default({})) | tojson }}; // mismas capas que ruteo
  const has = k => LAYERS_URL && typeof LAYERS_URL[k] === 'string' && LAYERS_URL[k].trim().length > 0;

  let map = L.map('map-local', { preferCanvas:true });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom:20 }).addTo(map);

  // Centro inicial:
  const startLat = parseFloat(latInput.value) || Number(DEPOT?.lat) || -25.3;
  const startLon = parseFloat(lonInput.value) || Number(DEPOT?.lon) || -57.6;
  map.setView([startLat, startLon], (latInput.value && lonInput.value) ? 14 : 12);

  // Pin arrastrable
  const pinIcon = L.divIcon({
    className: '',
    html: `
      <svg width="28" height="40" viewBox="0 0 28 40" xmlns="http://www.w3.org/2000/svg">
        <!-- cuerpo del pin -->
        <path d="M14 0C7.268 0 2 5.268 2 12c0 9.5 10.1 19.2 11.5 20.5a1.7 1.7 0 0 0 2.0 0C16.9 31.2 27 21.5 27 12 27 5.268 20.732 0 14 0Z"
              fill="#3b82f6" stroke="rgba(0,0,0,.35)" stroke-width="1"/>
        <!-- punto interno -->
        <circle cx="14" cy="12" r="5" fill="#ffffff" />
      </svg>
    `,
    iconSize: [28, 40],
    iconAnchor: [14, 40],   // la punta de la gota
    popupAnchor: [0, -36]
  });
  
  const marker = L.marker([startLat, startLon], { draggable:true, icon: pinIcon }).addTo(map);


  function setInputsFromLatLng(ll){
    latInput.value = ll.lat.toFixed(6);
    lonInput.value = ll.lng.toFixed(6);
  }
  marker.on('dragend', (e)=> setInputsFromLatLng(e.target.getLatLng()));

  // Click para reubicar pin y completar inputs
  map.on('click', (e)=>{
    marker.setLatLng(e.latlng);
    setInputsFromLatLng(e.latlng);
  });

  // Si el usuario edita manualmente lat/lon, mover el pin
  function moveMarkerFromInputs(){
    const la = parseFloat(latInput.value), lo = parseFloat(lonInput.value);
    if (!isNaN(la) && !isNaN(lo) && la>=-90 && la<=90 && lo>=-180 && lo<=180){
      marker.setLatLng([la,lo]); map.panTo([la,lo]);
    }
  }
  latInput.addEventListener('change', moveMarkerFromInputs);
  lonInput.addEventListener('change', moveMarkerFromInputs);

  // Centro log√≠stico (estrella)
  if (DEPOT && Number.isFinite(Number(DEPOT.lat)) && Number.isFinite(Number(DEPOT.lon))){
    const depotIcon = L.divIcon({ html:'<div class="depot-pin" style="width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:16px;background:#fbbf24;color:#0b1220;border:2px solid rgba(0,0,0,.35)">‚òÖ</div>', className:'', iconSize:[20,20], iconAnchor:[10,10] });
    L.marker([Number(DEPOT.lat), Number(DEPOT.lon)], { icon: depotIcon, interactive:false }).addTo(map)
      .bindPopup(`<strong>${DEPOT.name || 'Centro Log√≠stico'}</strong>`);
  }

  // Capas opcionales (barrios/distritos) igual que en ruteo ‚Äî liviano
  async function addPolygonLayer(url, style){
    const res = await fetch(url, { cache:'force-cache' });
    const gj = await res.json();
    L.geoJSON(gj, { style }).addTo(map);
  }
  if (has('barrios')){
    addPolygonLayer(LAYERS_URL.barrios, () => ({ weight:.7, color:'#7a9e6c', fillOpacity:.15 }));
  }

  // Geoloc
  document.getElementById('btnGeoloc').onclick = ()=>{
    if (!navigator.geolocation) return alert('Geolocalizaci√≥n no disponible');
    navigator.geolocation.getCurrentPosition(
      pos => {
        const la = pos.coords.latitude, lo = pos.coords.longitude;
        marker.setLatLng([la,lo]); setInputsFromLatLng({lat:la,lng:lo}); map.setView([la,lo], 16);
      },
      err => alert('No se pudo obtener tu ubicaci√≥n')
    );
  };
</script>
{% endblock %}
